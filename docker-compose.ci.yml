version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: squadmakers-postgres-ci
    environment:
      POSTGRES_USER: ci_user
      POSTGRES_PASSWORD: ci_password
      POSTGRES_DB: squadmakers_ci_db
    ports:
      - '5433:5432'  # Different port to avoid conflicts with dev
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ci_user -d squadmakers_ci_db']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - squadmakers-ci-network
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster CI tests (data is ephemeral)

  test:
    build:
      context: .
      dockerfile: Dockerfile.ci
    container_name: squadmakers-test-ci
    depends_on:
      postgres:
        condition: service_healthy
    # Note: env_file removed - all variables defined in environment section
    # This makes the CI portable (works in GitHub Actions without .env.ci file)
    environment:
      NODE_ENV: test
      CI: "true"
      DATABASE_URL: postgresql://ci_user:ci_password@postgres:5432/squadmakers_ci_db?schema=public
      CHUCK_NORRIS_API_URL: https://api.chucknorris.io
      DAD_JOKES_API_URL: https://icanhazdadjoke.com
      LOG_LEVEL: warn
    networks:
      - squadmakers-ci-network
    command:
      - /bin/sh
      - -c
      - |
        echo '‚è≥ Waiting for database...'
        sleep 2
        env | grep -i database || echo 'No DATABASE vars found'
        echo 'üîÑ Running Prisma migrations...'
        pnpm run db:generate
        npx prisma migrate deploy
        echo '‚úÖ Database ready!'
        echo 'üß™ Running tests...'
        pnpm run test:coverage
        echo '‚úÖ Tests completed!'

networks:
  squadmakers-ci-network:
    driver: bridge
